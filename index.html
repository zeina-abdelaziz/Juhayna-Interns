<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Juhayna</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="indexx.css">
<link rel="stylesheet" href="library/bootstrap.min.css">
<link id="bootstrap-css" rel="stylesheet" href="library/bootstrap.rtl.css">
<style>
  .camera-container {
    display: none;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
  }
  #video {
    width: 300px;
    border: 2px solid #ccc;
    border-radius: 5px;
  }
  #qrStatus {
    margin-top: 10px;
    font-weight: bold;
    color: #007bff;
  }
</style>
</head>
<body>

<div class="container-right">
  <div class="form-header">
    <img src="NewLogo2 (1).png" width="140px" height="auto" alt="Juhayna Logo" class="logo">
    <h1>تسجيل دخول و خروج السيارات</h1>
  </div>

  <p>التاريخ :</p>
  <div id="date"></div>
  <hr>

  <!-- QR Scan Button -->
  <button class="btn btn-primary" id="ShowCameraBtn">
    <img src="QRcodeIcon.png" alt="QR Code Icon"> مسح QR
  </button>

  <!-- Camera Container -->
  <div id="cameraContainer" class="camera-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="qrStatus"></div>
    <button class="btn btn-danger mt-2" id="closeCamBtn">إغلاق الكاميرا</button>
  </div>

  <p>رقم السياره:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" type="button" id="car">اختر رقم السياره</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="car-list"></ul>
    </div>
  </div>

  <p>اختر الفرع:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" type="button" id="branch">اختر الفرع</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="branch-list"></ul>
    </div>
  </div>

  <p>رقم المسار:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" type="button" id="route">اختر رقم المسار</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="route-list"></ul>
    </div>
  </div>

  <p>القطاع:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" type="button" id="sector">اختر القطاع</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="sector-list">
        <li>تجزئة جاف</li>
        <li>تجزئة مبرد</li>
        <li>اسواق خاصه</li>
      </ul>
    </div>
  </div>

  <p>ادخل عداد السيارة</p>
  <input type="text" class="form-control mb-2" id="odometer">

  <p>ملاحظات:</p>
  <textarea class="form-control mb-2" rows="3" placeholder="ملاحظات" id="note"></textarea>

  <div class="d-flex justify-content-around">
    <div class="row">
      <button type="button" class="btn btn-success btn-lg" onclick="handleSubmit('دخول')">دخول</button>
    </div>
    <div class="row">
      <button type="button" class="btn btn-danger btn-lg" onclick="handleSubmit('خروج')">خروج</button>
    </div>
  </div>
</div>

<!-- JSQR library for QR decoding -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
function getdata() {
  fetch("./extracted_unique_values.json")
    .then(response => response.json())
    .then(data => {
      fillList('branch-list', data.branch);
      fillList('car-list', data.carsnum);
      fillList('route-list', data.path_num);
    })
    .catch(err => console.error('Error fetching data:', err));
}
function fillList(listId, items) {
  const ul = document.getElementById(listId);
  ul.innerHTML = '';
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    ul.appendChild(li);
  });
}
getdata();

function handleSubmit(action) {
  const branch = document.getElementById("branch").textContent;
  const car = document.getElementById("car").textContent;
  const route = document.getElementById("route").textContent;
  const sector = document.getElementById("sector").textContent;
  const note = document.getElementById("note").value;
  const odometer = document.getElementById("odometer").value;
  const date = new Date().toLocaleDateString('en-US');
  const time = new Date().toLocaleTimeString('en-US');

  if (branch.includes("اختر") || car.includes("اختر") || route.includes("اختر") || sector.includes("اختر") || !odometer) {
    alert("يرجى ملء جميع الحقول المطلوبة.");
    return;
  }

  const formData = { branch, car, route, sector, note, action, date, time, odometer };

  fetch("https://script.google.com/macros/s/AKfycbwsmO2f_GfVwgZRUwjJJ7JPeXLRbiCZHxwypf0I_l_cFcwhi68LxW5WJ-9vqPeEZWhfuA/exec", {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(formData),
  })
  .then(r => r.ok ? r.json() : Promise.reject("Failed to submit"))
  .then(() => {
    alert("تم إرسال البيانات بنجاح!");
    location.reload();
  })
  .catch(err => {
    console.error("Error:", err);
    alert("حدث خطأ أثناء إرسال البيانات.");
  });
}

function toggleDropdown(button) {
  closeAllDropdowns();
  button.nextElementSibling.classList.toggle('show');
}
function filterList(input) {
  const filter = input.value.toUpperCase();
  const li = input.nextElementSibling.getElementsByTagName("li");
  for (let i = 0; i < li.length; i++) {
    const txtValue = li[i].textContent || li[i].innerText;
    li[i].style.display = txtValue.toUpperCase().includes(filter) ? "" : "none";
  }
}
function closeAllDropdowns() {
  const dropdowns = document.getElementsByClassName("dropdown-content");
  for (let i = 0; i < dropdowns.length; i++) {
    dropdowns[i].classList.remove('show');
  }
}
document.addEventListener("click", function(e) {
  if (e.target.tagName === "LI") {
    const dropdown = e.target.closest(".dropdown");
    const button = dropdown.querySelector(".dropbtn");
    button.textContent = e.target.textContent;
    closeAllDropdowns();
  }
});
document.getElementById("date").textContent = new Date().toLocaleDateString('en-US');

// ===== QR SCAN LOGIC =====
let stream = null;
let scanTimer = null;
const video  = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d');
const statusEl = document.getElementById('qrStatus');

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    });
    video.srcObject = stream;
    statusEl.textContent = 'جاري فتح الكاميرا...';
    await video.play();
    startScanLoop();
  } catch (e) {
    statusEl.textContent = 'تعذر فتح الكاميرا.';
  }
}
function stopCamera() {
  if (scanTimer) { cancelAnimationFrame(scanTimer); scanTimer = null; }
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  statusEl.textContent = '';
}
function startScanLoop() {
  const scan = () => {
    if (!video.videoWidth) {
      scanTimer = requestAnimationFrame(scan);
      return;
    }
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);
    if (code && code.data) {
      try {
        const payload = JSON.parse(code.data);
        statusEl.textContent = 'تمت قراءة الرمز ✅';
        if (payload.carsnum) document.getElementById('car').textContent = payload.carsnum;
        if (payload.branch)  document.getElementById('branch').textContent = payload.branch;
        if (payload.path_num) document.getElementById('route').textContent = payload.path_num;
        if (payload.sector)  document.getElementById('sector').textContent = payload.sector;
        stopCamera();
        document.getElementById('cameraContainer').style.display = 'none';
        return;
      } catch {
        statusEl.textContent = 'رمز غير صالح';
      }
    } else {
      statusEl.textContent = 'ابحث عن QR...';
    }
    scanTimer = requestAnimationFrame(scan);
  };
  scan();
}
document.getElementById('ShowCameraBtn').addEventListener('click', () => {
  const camBox = document.getElementById('cameraContainer');
  if (camBox.style.display === 'none') {
    camBox.style.display = 'flex';
    startCamera();
  } else {
    camBox.style.display = 'none';
    stopCamera();
  }
});
document.getElementById('closeCamBtn').addEventListener('click', () => {
  document.getElementById('cameraContainer').style.display = 'none';
  stopCamera();
});
</script>
</body>
</html>
