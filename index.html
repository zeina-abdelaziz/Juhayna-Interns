<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Juhayna</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="indexx.css">
<link rel="stylesheet" href="library/bootstrap.min.css">
<link id="bootstrap-css" rel="stylesheet" href="library/bootstrap.rtl.css">
</head>
<body>

<div class="container-right">
  <div class="form-header">
    <img src="NewLogo2 (1).png" width="140px" height="auto" alt="Juhayna Logo" class="logo">
    <h1>تسجيل دخول و خروج السيارات</h1>
  </div>

  <p>التاريخ :</p>
  <div id="date"></div>
  <hr>

  <p>رقم السياره:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" id="car">اختر رقم السياره</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="car-list"></ul>
    </div>
  </div>

  <p>اختر الفرع:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" id="branch">اختر الفرع</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="branch-list"></ul>
    </div>
  </div>

  <p>رقم المسار:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" id="route">اختر رقم المسار</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="route-list"></ul>
    </div>
  </div>

  <button id="add-route-btn" class="btn btn-primary" style="display:none; margin-bottom:20px;" onclick="showAdditionalRoute()">إضافة مسار</button>

  <div class="dropdown" id="additional-route-dropdown" style="display:none;">
    <p>إضافة مسار (إختياري):</p>
    <button onclick="toggleDropdown(this)" class="dropbtn" id="additional-route">اختر رقم المسار</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="additional-route-list"></ul>
    </div>
  </div>

  <p>القطاع:</p>
  <div class="dropdown">
    <button onclick="toggleDropdown(this)" class="dropbtn" id="sector">اختر القطاع</button>
    <div class="dropdown-content">
      <input type="text" placeholder="ابحث.." onkeyup="filterList(this)">
      <ul id="sector-list">
        <li>تجزئة جاف</li>
        <li>تجزئة مبرد</li>
        <li>اسواق خاصه</li>
      </ul>
    </div>
  </div>

  <p>ادخل عداد السيارة</p>
  <input type="text" class="form-control mb-2" id="odometer">

  <p>ملاحظات:</p>
  <textarea class="form-control mb-2" rows="3" placeholder="ملاحظات" id="note"></textarea>

  <!-- Hidden fields for QR/autofill mapping -->
  <input type="hidden" id="vanid" name="vanid">
  <input type="hidden" id="License_Plate" name="License_Plate">
  <input type="hidden" id="Branch" name="Branch">
  <input type="hidden" id="Route_Number" name="Route_Number">
  <input type="hidden" id="Sector" name="Sector">

  <div class="d-flex justify-content-around">
    <div class="row">
      <button type="button" class="btn btn-success btn-lg" onclick="handleSubmit('دخول')">دخول</button>
    </div>
    <div class="row">
      <button type="button" class="btn btn-danger btn-lg" onclick="handleSubmit('خروج')">خروج</button>
    </div>
  </div>
</div>

<script>
function getdata() {
  fetch("./extracted_unique_values.json")
    .then(response => response.json())
    .then(data => {
      fillList('branch-list', data.branch);
      fillList('car-list', data.carsnum);
      fillList('route-list', data.path_num);
      fillList('additional-route-list', data.path_num);
    })
    .catch(err => console.error('Error fetching data:', err));
}

function fillList(listId, items) {
  const ul = document.getElementById(listId);
  ul.innerHTML = '';
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    ul.appendChild(li);
  });
}

function handleSubmit(action) {
  const branch = document.getElementById("branch").textContent;
  const car = document.getElementById("car").textContent;
  const route = document.getElementById("route").textContent;
  const additionalRoute = document.getElementById("additional-route").textContent;
  const sector = document.getElementById("sector").textContent;
  const note = document.getElementById("note").value;
  const odometer = document.getElementById("odometer").value;
  const additionalRouteElement = document.getElementById("additional-route-dropdown");
  const now = new Date();
  const date = now.toLocaleDateString('en-US');
  const time = now.toLocaleTimeString('en-US');

  if (branch.includes("اختر") || car.includes("اختر") || route.includes("اختر") || sector.includes("اختر") || !odometer) {
    alert("يرجى ملء جميع الحقول المطلوبة.");
    return;
  }
  if (additionalRouteElement.style.display === "block" && additionalRoute.includes("اختر")) {
    alert("يرجى اختيار مسار إضافي إذا كنت تريد تسجيل .");
    return;
  } else if (additionalRouteElement.style.display === "block" && !additionalRoute.includes("اختر") && !note) {
    alert("يرجى كتابة سبب اضافة مسار اخر");
    return;
  }

  const formData = { branch, car, route, additionalRoute, sector, note, action, date, time, odometer };
  fetch("https://script.google.com/macros/s/AKfycbwsmO2f_GfVwgZRUwjJJ7JPeXLRbiCZHxwypf0I_l_cFcwhi68LxW5WJ-9vqPeEZWhfuA/exec", {
    method: "POST",
    redirect: "follow",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(formData),
  })
  .then(r => r.ok ? r.json() : Promise.reject("Failed to submit"))
  .then(() => {
    alert("تم إرسال البيانات بنجاح!");
    redirectToIndex();
  })
  .catch(err => {
    console.error("Error:", err);
    alert("حدث خطأ أثناء إرسال البيانات.");
  });
}

function redirectToIndex() { window.location.href = "index.html"; }
function showAdditionalRoute() {
  document.getElementById("additional-route-dropdown").style.display = "block";
  document.getElementById("add-route-btn").style.display = "none";
}
function printCurrentDate() {
  const today = new Date();
  document.getElementById("date").textContent = today.toLocaleDateString('en-US');
}
function toggleDropdown(button) {
  closeAllDropdowns();
  button.nextElementSibling.classList.toggle('show');
}
function filterList(input) {
  const filter = input.value.toUpperCase();
  const li = input.nextElementSibling.getElementsByTagName("li");
  for (let i = 0; i < li.length; i++) {
    const txtValue = li[i].textContent || li[i].innerText;
    li[i].style.display = txtValue.toUpperCase().includes(filter) ? "" : "none";
  }
}
function closeAllDropdowns() {
  const dropdowns = document.getElementsByClassName("dropdown-content");
  for (let i = 0; i < dropdowns.length; i++) {
    dropdowns[i].classList.remove('show');
  }
}
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn') && !event.target.matches('input')) {
    closeAllDropdowns();
  }
};
document.addEventListener("click", function(e) {
  if (e.target.tagName === "LI") {
    const dropdown = e.target.closest(".dropdown");
    const button = dropdown.querySelector(".dropbtn");
    button.textContent = e.target.textContent;
    closeAllDropdowns();
    if (button.id === "route") {
      document.getElementById("add-route-btn").style.display = "block";
    }
  }
});

// ✅ Onload: set date, fetch data, and autofill hidden fields from URL params
window.onload = function () {
  printCurrentDate();
  getdata();

  const params = new URLSearchParams(window.location.search);
  const mappings = {
    "van_id": "vanid",
    "plate": "License_Plate",
    "branch": "Branch",
    "route": "Route_Number",
    "sector": "Sector"
  };
  for (const [param, fieldId] of Object.entries(mappings)) {
    const value = params.get(param);
    if (value !== null) {
      const input = document.getElementById(fieldId);
      if (input) input.value = decodeURIComponent(value);
    }
  }
};

// ✅ Autofill from QR code parameters
window.addEventListener("load", function () {
  const params = new URLSearchParams(window.location.search);

  // Fill dropdown buttons (change button text)
  if (params.get("car")) {
    document.getElementById("car").textContent = decodeURIComponent(params.get("car"));
  }
  if (params.get("branch")) {
    document.getElementById("branch").textContent = decodeURIComponent(params.get("branch"));
  }
  if (params.get("route")) {
    document.getElementById("route").textContent = decodeURIComponent(params.get("route"));
  }
  if (params.get("sector")) {
    document.getElementById("sector").textContent = decodeURIComponent(params.get("sector"));
  }

  // Fill text inputs
  if (params.get("odometer")) {
    document.getElementById("odometer").value = decodeURIComponent(params.get("odometer"));
  }
  if (params.get("note")) {
    document.getElementById("note").value = decodeURIComponent(params.get("note"));
  }
});
</script>
</body>
</html>
